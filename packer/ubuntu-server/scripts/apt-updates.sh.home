#!/bin/bash

# This script updates the Ubuntu server packages, applies security updates, performs system upgrades,
# removes unnecessary packages, and cleans up the cache.
#
# Functions:
#   set_defaults: Initializes default values for the script options.
#   help: Displays the usage information and available options.
#   check_options: Parses and validates the command-line options.
#   run_update: Executes the update, upgrade, autoremove, and clean commands based on the provided options.

set -e

# This script updates the ubuntu server packages, security updates, system upgrades, removes unnecessary packages, and cleans up the cache.
set_defaults() {
  apt_update=false
  apt_upgrade=false
  apt_autoremove=false
  apt_clean=false
}

# if no arguments are passed, run the help message
help() {
  echo "Usage: ./updates.sh [-u] [-d] [-a] [-c] [-h] OR [-udac]"
  echo "Run all options: ./updates.sh -udac"
  echo "Options:"
  echo "  -u  Update the package list"
  echo "  -d  Upgrade the installed packages"
  echo "  -a  Remove unnecessary packages"
  echo "  -c  Clean up the cache"
  echo "  -h  Display this help message"
  exit 1
}

check_options() {
  if [ $# -eq 0 ]; then
    help
  fi
  while getopts "udach" opt; do
    case ${opt} in
      u )
        # set apt_update to true
        apt_update=true
        ;;
      d )
        # set apt_upgrade to true
        apt_upgrade=true
        ;;
      a )
        # set apt_autoremove to true
        apt_autoremove=true
        ;;
      c )
        # set apt_clean to true
        apt_clean=true
        ;;
      # update this to run if no arguments are passed
      h )
        help
        ;;
      \? )
        echo "Invalid option: $OPTARG"
        ;;
    esac
  done
  shift $((OPTIND -1))
}

# run the update, upgrade, autoremove, and clean commands
run_update() {
  if [ "$apt_update" = true ]; then
    echo -e "\e[1;32mUpdating package list...\e[0m"
    sudo apt update -y
    echo -e "\e[1;32mPackage list updated\e[0m"
  fi
  if [ "$apt_upgrade" = true ]; then
    echo -e "\e[1;32mUpgrading installed packages...\e[0m"
    sudo apt upgrade -y
    echo -e "\e[1;32mInstalled packages upgraded\e[0m"
  fi
  if [ "$apt_autoremove" = true ]; then
    echo -e "\e[1;32mRemoving unnecessary packages...\e[0m"
    sudo apt autoremove -y
    echo -e "\e[1;32mUnnecessary packages removed\e[0m"
  fi
  if [ "$apt_clean" = true ]; then
    # retry the clean command if it can't get a lock
    echo -e "\e[1;32mCleaning up the cache...\e[0m"
    sudo apt clean
    echo -e "\e[1;32mCache cleaned\e[0m"
  fi
}

set_defaults
check_options "$@"
run_update
